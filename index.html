<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simula√ß√£o ‚Äî Coleta ‚Üí Busca ‚Üí WhatsApp Clone</title>

<style>
  :root{
    --primary:#25D366; --primary-dark:#128C7E; --bg:#f5f5f1; --white:#fff;
    --muted:#7f8c8d; --text:#2c3e50; --danger:#ff3b30; --warn:#ffcc00;
    --success:#34c759;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Tahoma,Arial,Verdana,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

  /* ====== P√ÅGINAS ====== */
  .page{display:none}
  .page.active{display:block}

  /* ====== STEP 1 (coleta) + STEP 2 (loading/profile) ====== */
  .container{width:100%;max-width:980px;margin:20px auto;padding:0 16px}
  .card{background:var(--white);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:22px;margin-bottom:18px}
  h1{font-size:1.6rem;margin-bottom:8px}
  p.lead{color:var(--muted);margin-bottom:18px}
  .form-row{display:flex;gap:12px;align-items:center}
  .phone-input{flex:1;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:1rem;outline:none}
  .phone-input:focus{box-shadow:0 0 0 3px rgba(37,211,102,.12);border-color:var(--primary)}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .proofs{display:flex;flex-direction:column;gap:10px;margin-top:18px}
  .proof{background:#dcf8c6;padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center}
  .proof svg{width:18px;height:18px;fill:var(--primary)}

  .loading-wrap{display:none}
  .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(37,211,102,.2);border-top-color:var(--primary);animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),#0a8b63);width:0%;transition:width .4s ease}
  .log{background:#f6f7f8;border-radius:8px;padding:12px;height:180px;overflow:auto;font-family:monospace;margin-top:12px}
  .log-line{opacity:0;transform:translateY(8px);transition:opacity .25s,transform .25s;margin-bottom:8px}
  .log-line.visible{opacity:1;transform:none}

  .profile{display:none;margin-top:12px}
  .profile.visible{display:flex;flex-direction:column;gap:12px}
  .profile .head{display:flex;gap:12px;align-items:center}
  .profile img{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid var(--primary);background:#ddd}
  .detail{background:#fff;padding:12px;border-radius:10px}
  .confirm-bar{display:none;margin-top:12px;padding:10px;border:1px dashed #dde;border-radius:8px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn-danger{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}

  /* ====== P√ÅGINA WHATSAPP CLONE ====== */
  .wa-wrap{height:100vh;display:grid;grid-template-rows:auto 1fr}
  .wa-top{background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;gap:16px;padding:8px 14px}
  .wa-top .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid #e9eef0;background:#ddd}
  .wa-top .actions{margin-left:auto;display:flex;align-items:center;gap:14px;color:#96a0a6}
  .pill{background:var(--primary);color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;line-height:1.15;box-shadow:0 2px 0 rgba(0,0,0,.08)}
  .nav-tabs{display:flex;gap:28px;padding:12px 16px;background:#fff;border-bottom:1px solid #eee;align-items:center}
  .nav-tabs .tab{display:flex;align-items:center;gap:10px;color:#87959d;font-weight:800;letter-spacing:.06em}
  .nav-tabs .tab.active{color:#1c8f68}
  .nav-tabs svg{width:22px;height:22px;opacity:.85}
  .segmented{display:flex;gap:10px;padding:12px 16px;background:#fff;border-bottom:1px solid #eee}
  .segmented .seg{padding:10px 16px;border-radius:10px;background:#eaeff0;color:#8a9499;font-weight:800}
  .segmented .seg.active{background:var(--primary);color:#fff}

  .wa-main{display:grid;grid-template-columns:380px 1fr;min-height:0}
  .left-col{border-right:1px solid #e9edef;background:#fff;display:flex;flex-direction:column;min-height:0}
  .chatlist{overflow:auto}
  .chat-item{display:flex;gap:12px;padding:14px 16px;border-bottom:1px solid #f1f2f3;align-items:flex-start}
  .chat-item .pic{width:48px;height:48px;border-radius:50%;object-fit:cover;filter:blur(2px) saturate(.9) brightness(.92)}
  .chat-item .meta{flex:1}
  .chat-item .title{font-weight:800;margin-bottom:4px}
  .chat-item .sub{font-size:.92rem;color:#7d8a90;display:flex;align-items:center;gap:8px}
  .chat-item .right{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .chip{min-width:26px;height:26px;background:#1aaa65;color:#fff;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:800;padding:0 8px;font-size:.8rem}

  .right-col{background:#efeae2;display:flex;flex-direction:column;min-height:0}
  .msgs{flex:1;overflow:auto;padding:18px}
  .bubble{max-width:520px;padding:12px 14px;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.06);margin:12px 0}
  .bubble.left{background:#fff;border-top-left-radius:0}
  .bubble.right{background:#d9fdd3;margin-left:auto;border-top-right-radius:0}
  .composer{background:#f6f7f8;border-top:1px solid #e1e4e5;padding:10px 14px;display:flex;gap:12px;align-items:center}
  .composer input{flex:1;padding:12px 14px;border-radius:999px;border:1px solid #e0e0e0;background:#fff}
  .tool{width:40px;height:40px;border-radius:999px;background:#fff;border:1px solid #e2e5e6;display:flex;align-items:center;justify-content:center}

  /* toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:70px;background:#2d2f31;color:#fff;border-radius:6px;padding:10px 14px;display:none;align-items:center;gap:12px;z-index:9}
  .toast.show{display:flex}

  /* ====== MOBILE (aplicar layout do seu print 1) ====== */
  @media (max-width:768px){
    .wa-main{grid-template-columns:1fr}      /* s√≥ a coluna esquerda */
    .right-col{display:none}                 /* oculta as mensagens no mobile */
    .nav-tabs{gap:22px}
    .nav-tabs .tab{font-size:.95rem}
    .wa-top .actions{gap:12px}
  }

  /* reuso */
  .muted{color:#95a1a8}
  .row{display:flex;align-items:center;gap:10px}
  .success{color:var(--success)}
</style>
</head>
<body>

<!-- =========================================
=                 PAGE: FLOW                 =
========================================== -->
<section id="page-flow" class="page active">
  <div class="container">
    <!-- STEP 1 -->
    <section id="step-collect" class="card">
      <h1>Parab√©ns ‚Äî Acesso Gratuito</h1>
      <p class="lead">Insira o n√∫mero abaixo (simula√ß√£o). Em seguida iniciamos a ‚Äúbusca‚Äù e mostramos o perfil.</p>

      <div class="form-row">
        <input id="phoneInput" class="phone-input" type="tel" placeholder="(99) 99999-9999" maxlength="15" />
        <button id="cloneButton" class="btn" disabled>Clonar WhatsApp Agora</button>
      </div>

      <div class="proofs" id="simProofs">
        <div class="proof"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8Z"/></svg>
          <strong id="proofText1">(43) 96645-XX47 de Paran√° est√° sendo espionado neste momento...</strong></div>
        <div class="proof"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8Z"/></svg>
          <strong id="proofText2">(75) 91543-XX66 de Ilh√©us teve as conversas expostas!</strong></div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-loading" class="card loading-wrap" aria-hidden="true">
      <h1>Processando Acesso ao WhatsApp</h1>
      <p class="lead">Aguarde enquanto conectamos aos servidores e preparamos seu acesso.</p>

      <div class="row" style="flex-wrap:wrap">
        <div style="flex:0 0 120px;text-align:center">
          <div class="spinner" id="spinner"></div>
        </div>
        <div style="flex:1;min-width:220px">
          <div class="progress"><i id="progressFill"></i></div>
          <div class="muted" id="progressText" style="margin-top:8px">Conectando aos servidores... 0%</div>
          <div class="log" id="logContainer" aria-live="polite"></div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="profileCard" class="profile" style="margin-top:18px">
        <div class="head">
          <img id="imgProfile" src="https://i.postimg.cc/gcNd6QBM/img1.jpg" alt="Foto de perfil">
          <div>
            <div style="font-weight:800" id="profileName">Perfil WhatsApp</div>
            <div class="muted" id="numeroPerfil">(XX) XXXXX-XXXX</div>
            <div class="row success" style="margin-top:6px"><span style="width:9px;height:9px;background:var(--success);border-radius:50%"></span> Online recentemente</div>
          </div>
        </div>

        <div class="detail">
          <div class="row" style="margin-bottom:8px">
            <span class="muted">Cidade de √∫ltima conex√£o</span>
          </div>
          <div id="userCity" style="font-weight:700;margin-bottom:16px">Fortaleza</div>

          <div class="row">
            <span class="muted">Status do dispositivo</span>
          </div>
          <div style="font-weight:700">Ativo</div>

          <div style="margin-top:14px">
            <button class="btn" id="accessReportBtn">Acessar Relat√≥rio</button>
          </div>

          <!-- CONFIRM BAR -->
          <div id="confirmBar" class="confirm-bar">
            <span id="confirmText" style="font-weight:600">√â essa pessoa?</span>
            <div class="row">
              <button class="btn" id="btnYes">Sim</button>
              <button class="btn-danger" id="btnNo">N√£o, tentar sem 9</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</section>

<!-- =========================================
=         PAGE: WHATSAPP CLONE (CHAT)       =
========================================== -->
<section id="page-chat" class="page">
  <div class="wa-wrap">

    <!-- barra do topo -->
    <div class="wa-top">
      <img id="chatTopAvatar" class="avatar" src="https://i.postimg.cc/gcNd6QBM/img1.jpg" alt="avatar topo">
      <div class="pill" id="upgradePill">Liberar acesso completo<br>por R$ 27,90</div>
      <div class="actions">
        <!-- s√≥ ilustrativo -->
        <span>üîî</span><span>‚ãØ</span>
      </div>
    </div>

    <!-- abas -->
    <div class="nav-tabs">
      <div class="tab active" id="tabConversas">üó®Ô∏è <span>CONVERSAS</span></div>
      <div class="tab" id="tabLigacoes">üìû <span>LIGA√á√ïES</span></div>
      <div class="tab" id="tabContatos">üë§ <span>CONTATOS</span></div>
    </div>

    <!-- filtro -->
    <div class="segmented">
      <div class="seg active">PESSOAL</div>
      <div class="seg">GRUPOS</div>
    </div>

    <div class="wa-main">
      <!-- coluna esquerda -->
      <aside class="left-col">
        <div class="chatlist" id="chatList">
          <!-- Exemplo de item ‚Äî use suas imagens; blur aplicado pela classe .pic -->
          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/tC0qcD6S/blur1.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚úî Finalize a ordem de servi√ßo</div>
            </div>
            <div class="right">
              <div class="chip">3</div>
            </div>
          </div>

          <!-- Repita com outras imagens (troque os src abaixo se quiser) -->
          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/7LPVkpVb/blur2.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚ö† Conte√∫do com teor sexual oculto‚Ä¶</div>
            </div>
            <div class="right">
              <div class="chip">2</div>
            </div>
          </div>

          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/WbhjWbTQ/blur3.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚úî Finalize a ordem de servi√ßo</div>
            </div>
            <div class="right"><div class="chip">5</div></div>
          </div>

          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/6qdGQJ5b/blur4.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚úî Finalize a ordem de servi√ßo</div>
            </div>
          </div>

          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/vHpg8J7D/blur5.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚úî Finalize a ordem de servi√ßo</div>
            </div>
          </div>

          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/GmFQwcw7/blur6.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚úî Finalize a ordem de servi√ßo</div>
            </div>
          </div>

          <div class="chat-item">
            <img class="pic" src="https://i.postimg.cc/3RrFq0D5/blur7.jpg" alt="">
            <div class="meta">
              <div class="title">Bloqueado «Ä…£‚Äù‚Äù</div>
              <div class="sub">‚úî Finalize a ordem de servi√ßo</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- coluna direita (oculta no mobile para ficar igual seu print 1) -->
      <section class="right-col">
        <div class="msgs" id="msgs">
          <div class="bubble left">Conte√∫do Bloqueado √∞≈∏‚Äù‚Äù.</div>
          <div class="bubble right">Conte√∫do Bloqueado √∞≈∏‚Äù‚Äù. ‚úî‚úî</div>
          <div class="bubble left">Conte√∫do Bloqueado √∞≈∏‚Äù‚Äù.</div>
          <div class="bubble right">Conte√∫do Bloqueado √∞≈∏‚Äù‚Äù. ‚úî‚úî</div>
        </div>

        <div class="composer">
          <div class="tool">üòä</div>
          <div class="tool">üìé</div>
          <input type="text" placeholder="Escreva sua mensagem">
          <div class="tool">üì∑</div>
          <div class="tool">üé§</div>
        </div>
      </section>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast"><span>‚ö†</span> <strong>Novas mensagens encontradas...</strong></div>
</section>

<script>
/* ============ utils & m√°scaras ============ */
function maskBrPhone(v){
  let d = v.replace(/\D/g, '').slice(0, 11);
  if (d.length <= 2) return '(' + d;
  if (d.length <= 6) return `(${d.slice(0,2)}) ${d.slice(2)}`;
  if (d.length <= 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`; // 10 d√≠gitos (sem 9)
  return `(${d.slice(0,2)}) ${d.slice(2,3)} ${d.slice(3,7)}-${d.slice(7,11)}`;   // 11 d√≠gitos (com 9)
}
function formatarNumeroBrasil(numero){
  let num = (numero||'').replace(/\D/g,'');
  if(num.startsWith('55')) num = num.substr(2);
  if(num.length === 11) return num.replace(/^(\d{2})(\d{1})(\d{4})(\d{4})$/,'($1) $2 $3-$4');
  if(num.length === 10) return num.replace(/^(\d{2})(\d{4})(\d{4})$/,'($1) $2-$3');
  return numero;
}
function getNumeroApi(numero){
  let n = (numero||'').replace(/\D/g,'');
  if(!n.startsWith('55')) n = '55'+n;
  return n;
}
function resolveCandidatesForInteractive(raw){
  let num = (raw||'').replace(/\D/g,'');
  if(!num.startsWith('55')) num = '55' + num;
  const local = num.slice(2), ddd = local.slice(0,2), rest = local.slice(2);
  let preferred = num, alt = null;
  if(rest.length === 8){ preferred = '55'+ddd+'9'+rest; alt = num; }
  else if(rest.length === 9){ alt = '55'+ddd+(rest.startsWith('9')?rest.slice(1):rest.slice(1)); }
  return { preferred, alt, hasAlt: !!alt };
}
async function fetchWithTimeout(url, options = {}, timeoutMs = 10000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeoutMs);
  try{ return await fetch(url, {...options, signal:controller.signal}); }
  finally{ clearTimeout(id); }
}

/* ============ ELEMENTOS FLOW ============ */
const pageFlow = document.getElementById('page-flow');
const pageChat = document.getElementById('page-chat');

const phoneInput = document.getElementById('phoneInput');
const cloneButton = document.getElementById('cloneButton');
const stepCollect = document.getElementById('step-collect');
const stepLoading = document.getElementById('step-loading');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const logContainer = document.getElementById('logContainer');
const profileCard = document.getElementById('profileCard');
const imgProfile = document.getElementById('imgProfile');
const numeroPerfil = document.getElementById('numeroPerfil');
const userCityElement = document.getElementById('userCity');
const accessReportBtn = document.getElementById('accessReportBtn');
const confirmBar = document.getElementById('confirmBar');
const confirmText = document.getElementById('confirmText');
const btnYes = document.getElementById('btnYes');
const btnNo  = document.getElementById('btnNo');

/* ============ ELEMENTOS CHAT ============ */
const chatTopAvatar = document.getElementById('chatTopAvatar');
const toast = document.getElementById('toast');

/* ===== prova din√¢mica (s√≥ est√©tica) ===== */
const dddToState = {'11':'S√£o Paulo','12':'S√£o Paulo','13':'S√£o Paulo','14':'S√£o Paulo','15':'S√£o Paulo','16':'S√£o Paulo','17':'S√£o Paulo','18':'S√£o Paulo','19':'S√£o Paulo','21':'Rio de Janeiro','22':'Rio de Janeiro','24':'Rio de Janeiro','27':'Esp√≠rito Santo','28':'Esp√≠rito Santo','31':'Minas Gerais','32':'Minas Gerais','33':'Minas Gerais','34':'Minas Gerais','35':'Minas Gerais','37':'Minas Gerais','38':'Minas Gerais','41':'Paran√°','42':'Paran√°','43':'Paran√°','44':'Paran√°','45':'Paran√°','46':'Paran√°','47':'Santa Catarina','48':'Santa Catarina','49':'Santa Catarina','51':'Rio Grande do Sul','53':'Rio Grande do Sul','54':'Rio Grande do Sul','55':'Rio Grande do Sul','61':'Distrito Federal','62':'Goi√°s','63':'Tocantins','64':'Goi√°s','65':'Mato Grosso','66':'Mato Grosso','67':'Mato Grosso do Sul','68':'Acre','69':'Rond√¥nia','71':'Bahia','73':'Bahia','74':'Bahia','75':'Bahia','77':'Bahia','79':'Sergipe','81':'Pernambuco','82':'Alagoas','83':'Para√≠ba','84':'Rio Grande do Norte','85':'Cear√°','86':'Piau√≠','87':'Pernambuco','88':'Cear√°','89':'Piau√≠','91':'Par√°','92':'Amazonas','93':'Par√°','94':'Par√°','95':'Roraima','96':'Amap√°','97':'Amazonas','98':'Maranh√£o','99':'Maranh√£o'};
const allDDDs = Object.keys(dddToState);
const actions = ['est√° sendo clonado agora...','est√° sendo monitorado silenciosamente...','teve as mensagens interceptadas!','est√° sob vigil√¢ncia agora...','foi rastreado com sucesso!','teve o WhatsApp clonado com sucesso!','est√° sendo espionado neste momento...','teve as conversas expostas!','est√° sendo rastreado em tempo real...','teve o acesso liberado para monitoramento!','teve o hist√≥rico de chamadas acessado!','est√° com todas as mensagens sendo monitoradas!','teve o WhatsApp hackeado com sucesso!','est√° com localiza√ß√£o sendo rastreada!','teve as fotos e v√≠deos acessados!'];
function randProof(){
  const ddd = allDDDs[Math.floor(Math.random()*allDDDs.length)];
  const first = Math.floor(Math.random()*10000).toString().padStart(4,'0');
  const last  = 'XX'+Math.floor(Math.random()*100).toString().padStart(2,'0');
  const formatted = `(${ddd}) 9${first.substring(0,4)}-${last}`;
  const state = dddToState[ddd] || 'Brasil';
  return `${formatted} de ${state} ${actions[Math.floor(Math.random()*actions.length)]}`;
}
document.getElementById('proofText1').textContent = randProof();
document.getElementById('proofText2').textContent = randProof();
setInterval(()=>{ document.getElementById('proofText1').textContent = randProof(); }, 4000);
setInterval(()=>{ document.getElementById('proofText2').textContent = randProof(); }, 6000);

/* ===== m√°scara + habilitar bot√£o ===== */
phoneInput.addEventListener('input', (e)=>{
  const v = maskBrPhone(e.target.value);
  e.target.value = v;
  if (v.replace(/\D/g,'').length >= 10) cloneButton.removeAttribute('disabled');
  else cloneButton.setAttribute('disabled','');
});

/* ===== navega√ß√£o entre p√°ginas ===== */
function showPage(hash){
  const target = (hash === '#chat') ? 'chat' : 'flow';
  document.getElementById('page-flow').classList.toggle('active', target==='flow');
  document.getElementById('page-chat').classList.toggle('active', target==='chat');

  // quando abrir o chat, seta avatar do topo com a foto salva (se existir)
  if(target==='chat'){
    const fotoperfil = localStorage.getItem('fotoperfil');
    chatTopAvatar.src = fotoperfil || 'https://i.postimg.cc/gcNd6QBM/img1.jpg';
  }
}
window.addEventListener('hashchange', ()=>showPage(location.hash));
showPage(location.hash);

/* ===== bot√£o ‚ÄúAcessar Relat√≥rio‚Äù ===== */
/* COLE SEU LINK AQUI (se quiser redirecionar para outra p√°gina externa):
   Ex.: const REPORT_URL = "https://seu-dominio.com/whatsapp-clone.html";
   Se deixar vazio (""), ele abre a P√ÅGINA #chat deste mesmo arquivo.
*/
const REPORT_URL = ""; // <<< COLE AQUI SEU LINK >>>

accessReportBtn.addEventListener('click', ()=>{
  if(REPORT_URL && REPORT_URL.trim()){
    window.open(REPORT_URL, '_blank');
  }else{
    // abre a pr√≥pria p√°gina de chat deste arquivo
    location.hash = 'chat';
  }
});

/* ===== fluxo de coleta ‚Üí loading ‚Üí perfil ===== */
cloneButton.addEventListener('click', ()=>{
  const phone = phoneInput.value.trim();
  if(!phone) return;
  localStorage.setItem('numeroClonado', phone);

  // mostra loading
  stepCollect.style.display = 'none';
  stepLoading.style.display = 'block';
  stepLoading.setAttribute('aria-hidden','false');
  startLoadingFlow();
});

const logMessages = [
  { text: 'Iniciando conex√£o com servidores WhatsApp...', delay: 800 },
  { text: 'Localizando servidor mais pr√≥ximo...', delay: 1800 },
  { text: 'Servidor localizado! Estabelecendo conex√£o segura...', delay: 3200 },
  { text: 'Verificando n√∫mero de telefone...', delay: 4800 },
  { text: 'N√∫mero de telefone v√°lido!', delay: 6400 },
  { text: 'Analisando base de dados...', delay: 8200 },
  { text: 'Buscando informa√ß√µes de perfil...', delay: 10000 },
  { text: 'Detectando localiza√ß√£o do dispositivo...', delay: 11800 },
  { text: '', delay: 14000, isLocation:true },
  { text: 'Preparando canal privado de leitura...', delay: 16000 },
  { text: 'Canal privado estabelecido!', delay: 17800 },
  { text: 'Sincronizando mensagens...', delay: 19800 },
  { text: 'Sincroniza√ß√£o completa!', delay: 21800 },
  { text: 'Acesso concedido com sucesso!', delay: 23800 }
];

function addLogLine(text){
  const node = document.createElement('div');
  node.className = 'log-line';
  node.textContent = text;
  logContainer.appendChild(node);
  logContainer.scrollTop = logContainer.scrollHeight;
  setTimeout(()=>node.classList.add('visible'),50);
}
function setProgress(p){
  progressFill.style.width = p+'%';
  progressText.textContent = `Conectando aos servidores... ${p}%`;
}

function startLoadingFlow(){
  // reset
  logContainer.innerHTML = '';
  profileCard.classList.remove('visible');
  imgProfile.src = 'https://i.postimg.cc/gcNd6QBM/img1.jpg';
  numeroPerfil.textContent = localStorage.getItem('numeroClonado') || '(XX) XXXXX-XXXX';
  userCityElement.textContent = 'Carregando...';
  confirmBar.style.display = 'none';
  setProgress(2);

  // logs + cidade
  logMessages.forEach(msg=>{
    setTimeout(async ()=>{
      if(msg.isLocation){
        try{
          const res = await fetch('https://wtfismyip.com/json');
          const data = await res.json();
          const userCity = data.YourFuckingCity || data.city || 'Fortaleza';
          const userCountry = data.YourFuckingCountry || data.country || 'Brasil';
          addLogLine(`Localiza√ß√£o suspeita encontrada em ${userCity}, ${userCountry}`);
          userCityElement.textContent = userCity;
        }catch(e){
          addLogLine('N√£o foi poss√≠vel detectar localiza√ß√£o precisa');
          userCityElement.textContent = 'Fortaleza';
        }
      }else addLogLine(msg.text);
    }, msg.delay);
  });

  // progresso
  let progress = 2;
  const int = setInterval(()=>{
    progress = Math.min(100, progress + Math.ceil(Math.random()*3));
    setProgress(progress);
    if(progress>=100){
      clearInterval(int);
      setTimeout(()=>{
        profileCard.classList.add('visible');
        const numeroApi = getNumeroApi(localStorage.getItem('numeroClonado')||'');
        iniciarBuscaComConfirmacao(numeroApi);
      }, 900);
    }
  }, 250);
}

/* ===== buscar perfil ===== */
async function fetchProfileOnce(candidate){
  const url = "https://w.imagens.pics/webhook/182dd";
  const key = "wuAsuKHImXennBSFjt895tu984ut5";
  let foto = null, statusTxt = '', errorDetail = null;

  // POST
  try{
    addLogLine(`Consultando perfil (${candidate}) via POST...`);
    const resp = await fetchWithTimeout(url, {
      method:'POST',
      headers:{"Content-Type":"application/json","key":key},
      body:JSON.stringify({ number:candidate })
    }, 12000);
    if(resp.ok){
      const data = await resp.json();
      foto = data.foto || data.photo || null;
      statusTxt = data.Status || data.status || '';
      if(foto) return { ok:true, foto, statusTxt };
      errorDetail = 'POST ok, mas sem foto';
    }else errorDetail = `POST ${resp.status}`;
  }catch(e){ errorDetail = 'POST falhou'; }

  // GET
  try{
    addLogLine(`Tentando via GET (fallback) para ${candidate}...`);
    const u = `${url}?number=${encodeURIComponent(candidate)}&key=${encodeURIComponent(key)}`;
    const resp2 = await fetchWithTimeout(u, {method:'GET'}, 12000);
    if(resp2.ok){
      const data2 = await resp2.json();
      foto = data2.foto || data2.photo || null;
      statusTxt = data2.Status || data2.status || '';
      if(foto) return { ok:true, foto, statusTxt };
      errorDetail = 'GET ok, mas sem foto';
    }else errorDetail = `GET ${resp2.status}`;
  }catch(e2){ errorDetail = 'GET falhou'; }

  return { ok:false, foto:null, statusTxt:'', errorDetail };
}

async function diagnosticarWebhook(numero){
  const url = "https://w.imagens.pics/webhook/182dd";
  const key = "wuAsuKHImXennBSFjt895tu984ut5";
  async function tryOnce(n, mode){
    if(mode==='POST'){
      return await fetchWithTimeout(url,{
        method:'POST',headers:{"Content-Type":"application/json","key":key},
        body:JSON.stringify({number:n})
      },8000);
    }else{
      const u = `${url}?number=${encodeURIComponent(n)}&key=${encodeURIComponent(key)}`;
      return await fetchWithTimeout(u,{method:'GET'},8000);
    }
  }
  let result = { reached:false, connected:false, code:null };
  for (const mode of ['POST','GET']){
    try{
      const resp = await tryOnce(numero, mode);
      result.code = resp.status;
      if(resp.ok){
        result.reached = true;
        const data = await resp.json().catch(()=>null);
        const statusStr = (data && (data.status || data.Status)) ? String(data.status || data.Status).toLowerCase() : '';
        const hasFoto = !!(data && (data.foto || data.photo));
        result.connected = hasFoto || /connect|online|session|ok|success/.test(statusStr);
        return result;
      }
    }catch(e){}
  }
  return result;
}

async function iniciarBuscaComConfirmacao(numeroApi){
  const { preferred, alt, hasAlt } = resolveCandidatesForInteractive(numeroApi);

  // tentativa 1 (preferida)
  const res1 = await fetchProfileOnce(preferred);

  numeroPerfil.textContent = formatarNumeroBrasil(localStorage.getItem('numeroClonado')||'');
  if(res1.ok){
    imgProfile.src = res1.foto;
    localStorage.setItem('fotoperfil', res1.foto);
    localStorage.setItem('Status', res1.statusTxt||'');
    addLogLine('Perfil carregado com sucesso!');
  }else{
    imgProfile.src = 'https://i.postimg.cc/gcNd6QBM/img1.jpg';
    addLogLine('N√£o foi poss√≠vel obter a foto do perfil.');
    if(res1.errorDetail) addLogLine(`Detalhe: ${res1.errorDetail}`);
  }

  // diagn√≥stico
  try{
    const diag = await diagnosticarWebhook(numeroApi);
    if(!diag.reached) addLogLine('Diagn√≥stico: webhook n√£o respondeu.');
    else if(diag.connected) addLogLine('Diagn√≥stico: webhook ativo e h√° sinais de sess√£o WhatsApp conectada.');
    else addLogLine(`Diagn√≥stico: webhook respondeu ${diag.code}, mas sem sinais claros de sess√£o ativa.`);
  }catch(e){ addLogLine('Diagn√≥stico: erro inesperado.'); }

  // confirma√ß√£o (varia√ß√£o com/sem 9)
  if(hasAlt){
    const altLocalLen = alt.replace(/^55/,'').length;
    btnNo.textContent = (altLocalLen===10) ? 'N√£o, tentar sem 9' : 'N√£o, tentar com 9';
    confirmText.textContent = res1.ok ? '√â essa pessoa?' : 'N√£o encontramos foto com este formato. Tentar outra varia√ß√£o?';
    confirmBar.style.display = 'flex';

    btnYes.onclick = ()=>{
      confirmBar.style.display = 'none';
      btnYes.onclick = btnNo.onclick = null;
    };
    btnNo.onclick = async ()=>{
      btnNo.disabled = btnYes.disabled = true;
      addLogLine('Refazendo busca com a outra varia√ß√£o do n√∫mero...');
      const res2 = await fetchProfileOnce(alt);
      if(res2.ok){
        imgProfile.src = res2.foto;
        localStorage.setItem('fotoperfil', res2.foto);
        localStorage.setItem('Status', res2.statusTxt||'');
        addLogLine('Novo perfil carregado com sucesso!');
      }else{
        addLogLine('Tamb√©m n√£o foi poss√≠vel obter a foto nesta varia√ß√£o.');
        if(res2.errorDetail) addLogLine(`Detalhe: ${res2.errorDetail}`);
      }
      confirmBar.style.display = 'none';
      btnNo.disabled = btnYes.disabled = false;
      btnYes.onclick = btnNo.onclick = null;
    };
  }else{
    confirmBar.style.display = 'none';
  }
}

/* ===== toast de novas mensagens a cada 6s ===== */
setInterval(()=>{
  if(location.hash !== '#chat') return;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 2000);
}, 6000);

/* ===== iniciar com n√∫mero salvo (conveni√™ncia) ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem('numeroClonado');
  if(saved){
    phoneInput.value = maskBrPhone(saved);
    cloneButton.removeAttribute('disabled');
  }
  // ao entrar no chat direto por hash, carrega avatar do topo
  if(location.hash==='#chat'){
    const fp = localStorage.getItem('fotoperfil');
    chatTopAvatar.src = fp || chatTopAvatar.src;
  }
});
</script>
</body>
</html>
