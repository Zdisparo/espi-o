<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Demo Mensageiro — Coleta → Busca → Chat</title>

<style>
  :root{
    --primary:#25D366; --primary-dark:#128C7E; --bg:#f5f5f1; --white:#fff;
    --muted:#7f8c8d; --text:#1f2a32; --danger:#ff3b30; --warn:#ffcc00;
    --success:#34c759; --soft:#edf2f4; --line:#e6e8ea; --chip:#1aaa65;
    --overlay:rgba(0,0,0,.45);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',Tahoma,Arial,Verdana,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

  /* ====== PÁGINAS ====== */
  .page{display:none}
  .page.active{display:block}

  /* ====== STEP 1 (coleta) + STEP 2 (loading/profile) ====== */
  .container{width:100%;max-width:980px;margin:20px auto;padding:0 16px}
  .card{background:var(--white);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.07);padding:22px;margin-bottom:18px}
  h1{font-size:1.6rem;margin-bottom:8px}
  p.lead{color:var(--muted);margin-bottom:18px}
  .form-row{display:flex;gap:12px;align-items:center}
  .phone-input{flex:1;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:1rem;outline:none}
  .phone-input:focus{box-shadow:0 0 0 3px rgba(37,211,102,.12);border-color:var(--primary)}
  .btn{background:var(--primary);color:#fff;border:0;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn-danger{background:var(--danger);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}

  .proofs{display:flex;flex-direction:column;gap:10px;margin-top:18px}
  .proof{background:#dcf8c6;padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center}
  .proof svg{width:18px;height:18px;fill:var(--primary)}

  .loading-wrap{display:none}
  .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(37,211,102,.2);border-top-color:var(--primary);animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  .progress{height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),#0a8b63);width:0%;transition:width .4s ease}
  .log{background:#f6f7f8;border-radius:8px;padding:12px;height:180px;overflow:auto;font-family:monospace;margin-top:12px}
  .log-line{opacity:0;transform:translateY(8px);transition:opacity .25s,transform .25s;margin-bottom:8px}
  .log-line.visible{opacity:1;transform:none}

  .profile{display:none;margin-top:12px}
  .profile.visible{display:flex;flex-direction:column;gap:12px}
  .profile .head{display:flex;gap:12px;align-items:center}
  .profile img{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid var(--primary);background:#ddd}
  .detail{background:#fff;padding:12px;border-radius:10px}
  .confirm-bar{display:none;margin-top:12px;padding:10px;border:1px dashed #dde;border-radius:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}

  /* ====== PÁGINA CHAT (MOBILE FIRST) ====== */
  .home-wrap{min-height:100dvh;display:flex;flex-direction:column}
  .util-top{display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--line)}
  .util-top .avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #eef3f4;background:#ddd}
  .pill{margin-left:auto;background:#2fd070;color:#fff;border-radius:12px;padding:8px 12px;font-weight:800;line-height:1.1;box-shadow:0 2px 0 rgba(0,0,0,.08);cursor:pointer;animation:pulse 2s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

  .appbar{background:#fff;padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center}
  .appbar h2{font-size:1.4rem;letter-spacing:.2px}
  .appbar .actions{margin-left:auto;display:flex;gap:14px;color:#7c8b93}
  .gate{cursor:pointer}

  .searchbar{background:#fff;padding:10px 14px;border-bottom:1px solid var(--line)}
  .search{background:#f1f3f4;border-radius:999px;padding:12px 14px;display:flex;gap:10px;align-items:center;color:#94a0a7}
  .search input{border:none;background:transparent;outline:none;flex:1;color:#54606a}

  .list{background:#fff;flex:1;overflow:auto}
  .row-chat{display:flex;gap:12px;padding:12px 14px;border-bottom:1px solid var(--line);align-items:center}
  .pic{width:52px;height:52px;border-radius:50%;object-fit:cover;filter:blur(2px) saturate(.9) brightness(.92)}
  .meta{flex:1;min-width:0}
  .name{font-weight:800}
  .preview{font-size:.95rem;color:#748089;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
  .righty{display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:52px}
  .time{font-size:.85rem;color:#7e8a92}
  .badge{background:#25d366;color:#fff;border-radius:999px;min-width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:800;padding:0 6px;font-size:.8rem}

  .bottom-nav{background:#fff;border-top:1px solid var(--line);display:flex;justify-content:space-around;padding:8px 0}
  .bn-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:#64717a;font-weight:600;font-size:.9rem}
  .bn-item.active{color:#1f9c63}
  .bn-badge{position:absolute;margin-left:28px;margin-top:-10px;background:#1f9c63;color:#fff;border-radius:999px;padding:2px 8px;font-weight:800;font-size:.8rem}

  .fab{position:fixed;right:16px;bottom:80px;background:#1f9c63;color:#fff;width:58px;height:58px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 20px rgba(0,0,0,.12);font-size:1.6rem;cursor:pointer}

  .toast{position:fixed;left:50%;transform:translateX(-50%);top:70px;background:#2d2f31;color:#fff;border-radius:6px;padding:10px 14px;display:none;align-items:center;gap:12px;z-index:9}
  .toast.show{display:flex}

  /* Modal paywall (convite) */
  .pay-modal{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:100}
  .pay-modal.show{display:flex}
  .pay-box{background:#fff;width:calc(100% - 40px);max-width:420px;border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.18);animation:pop .2s ease}
  .pay-title{font-weight:900;font-size:1.2rem;margin-bottom:8px}
  .pay-sub{color:#6d7a82;margin-bottom:14px}
  .btn-outline{background:#eef3f4;color:#2a2f33;border:0;padding:12px 16px;border-radius:10px;font-weight:800}
  .pay-actions{display:flex;gap:10px;flex-wrap:wrap}
  @keyframes pop{from{transform:scale(.96);opacity:.7}to{transform:scale(1);opacity:1}}

  /* Modal checkout (iframe) */
  .checkout-modal{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:110}
  .checkout-modal.show{display:flex}
  .checkout-box{background:#fff;width:calc(100% - 24px);max-width:520px;height:80vh;border-radius:14px;box-shadow:0 16px 36px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;animation:pop .2s ease}
  .checkout-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  .checkout-head strong{font-weight:900}
  .checkout-body{flex:1}
  .checkout-body iframe{border:0;width:100%;height:100%}
  .checkout-foot{padding:10px 12px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end}
  .btn-ghost{background:transparent;border:1px solid #d7dde1;color:#2a2f33;border-radius:10px;padding:10px 14px;font-weight:800}

  /* Modal dica (flow) */
  .hint-modal{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:200}
  .hint-modal.show{display:flex}
  .hint-box{background:#fff;width:calc(100% - 40px);max-width:520px;border-radius:14px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.18);animation:pop .2s ease}
  .hint-title{font-weight:900;font-size:1.1rem;margin-bottom:8px}
  .hint-text{color:#44525c;margin-bottom:14px;line-height:1.45}

  /* Overlay de conexão ao trocar para os chats */
  .connect-overlay{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;align-items:center;justify-content:center;z-index:250}
  .connect-overlay.show{display:flex}
  .connect-box{background:#fff;border:1px solid var(--line);border-radius:14px;padding:22px;box-shadow:0 14px 38px rgba(0,0,0,.18);text-align:center;width:calc(100% - 64px);max-width:380px}
  .connect-spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(37,211,102,.2);border-top-color:var(--primary);animation:spin 1s linear infinite;margin:0 auto 12px}
  .connect-title{font-weight:900;margin-bottom:6px}
  .connect-sub{color:#6b7880}
  .connect-dots::after{content:"";animation:dots 1.2s steps(4) infinite}
  @keyframes dots{0%{content:""}25%{content:"."}50%{content:".."}75%{content:"..."}100%{content:""}}

  /* Digitando... */
  .typing{color:#7aa395;font-style:italic}
  .dots::after{content:"";animation:dots 1.2s steps(4) infinite}

  @media (min-width:769px){
    .home-wrap{max-width:520px;margin:0 auto;border-left:1px solid var(--line);border-right:1px solid var(--line)}
  }

  .muted{color:#95a1a8}
  .row{display:flex;align-items:center;gap:10px}
  .success{color:var(--success)}
</style>
</head>
<body>

<!-- =========================================
=                 PAGE: FLOW                 =
========================================== -->
<section id="page-flow" class="page active">
  <div class="container">
    <!-- STEP 1 -->
    <section id="step-collect" class="card">
      <h1>Bem-vindo — Acesso de Demonstração</h1>
      <p class="lead">Insira um número (exemplo BR). Em seguida simulamos a busca e mostramos o perfil.</p>

      <div class="form-row">
        <input id="phoneInput" class="phone-input" type="tel" placeholder="(99) 99999-9999" maxlength="15" />
        <button id="cloneButton" class="btn" disabled>Continuar</button>
      </div>

      <div class="proofs" id="simProofs">
        <div class="proof"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8Z"/></svg>
          <strong id="proofText1">(11) 98765-XX12 — perfil sincronizado recentemente…</strong></div>
        <div class="proof"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8Z"/></svg>
          <strong id="proofText2">(21) 97654-XX34 — conversas recentes identificadas…</strong></div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section id="step-loading" class="card loading-wrap" aria-hidden="true">
      <h1>Processando acesso</h1>
      <p class="lead">Aguarde enquanto preparamos o ambiente de demonstração.</p>

      <div class="row" style="flex-wrap:wrap">
        <div style="flex:0 0 120px;text-align:center">
          <div class="spinner" id="spinner"></div>
        </div>
        <div style="flex:1;min-width:220px">
          <div class="progress"><i id="progressFill"></i></div>
          <div class="muted" id="progressText" style="margin-top:8px">Conectando aos servidores... 0%</div>
          <div class="log" id="logContainer" aria-live="polite"></div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="profileCard" class="profile" style="margin-top:18px">
        <div class="head">
          <img id="imgProfile" src="https://i.postimg.cc/gcNd6QBM/img1.jpg" alt="Foto de perfil">
          <div>
            <div style="font-weight:800" id="profileName">Perfil do Usuário</div>
            <div class="muted" id="numeroPerfil">(XX) XXXXX-XXXX</div>
            <div class="row success" style="margin-top:6px"><span style="width:9px;height:9px;background:var(--success);border-radius:50%"></span> Online recentemente</div>
          </div>
        </div>

        <div class="detail">
          <div class="row" style="margin-bottom:8px"><span class="muted">Cidade de última conexão</span></div>
          <div id="userCity" style="font-weight:700;margin-bottom:16px">Carregando...</div>
          <div class="row"><span class="muted">Status do dispositivo</span></div>
          <div style="font-weight:700">Ativo</div>

          <!-- CONFIRM BAR (só depois da busca) -->
          <div id="confirmBar" class="confirm-bar">
            <div class="row" style="flex:1;min-width:220px">
              <span id="confirmText" style="font-weight:700">É esse perfil?</span>
            </div>
            <div class="row" style="flex-wrap:wrap;gap:8px">
              <button class="btn" id="btnYes">Sim</button>
              <button class="btn-danger" id="btnNo">Tentar formato alternativo</button>
              <button class="btn" id="accessReportBtn">Acessar Relatório</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</section>

<!-- =========================================
=         PAGE: HOME DO MENSAGEIRO          =
========================================== -->
<section id="page-chat" class="page">
  <div class="home-wrap">

    <!-- topo com avatar + pílula -->
    <div class="util-top">
      <img id="chatTopAvatar" class="avatar" src="https://i.postimg.cc/gcNd6QBM/img1.jpg" alt="avatar topo">
      <div id="upgradePill" class="pill gate">Liberar acesso completo<br>por R$ 29,97</div>
    </div>

    <!-- Appbar -->
    <div class="appbar">
      <h2 class="gate">Mensagens</h2>
      <div class="actions">
        <span class="gate">📷</span><span class="gate">⚙️</span><span class="gate">⋮</span>
      </div>
    </div>

    <!-- Busca -->
    <div class="searchbar">
      <div class="search gate">
        <span class="icon">🔎</span>
        <input placeholder="Pesquisar ou iniciar conversa" readonly>
      </div>
    </div>

    <!-- Lista de conversas -->
    <div id="chatList" class="list">
      <div class="row-chat gate">
        <img class="pic" src="sarinha.png" alt="">
        <div class="meta">
          <div class="name">Sarinha</div>
          <div class="preview">Oi, tudo bem? Posso te perguntar um...</div>
        </div>
        <div class="righty">
          <div class="time">20:04</div>
          <div class="badge">1</div>
        </div>
      </div>

      <div class="row-chat gate">
        <img class="pic" src="amanda.png" alt="">
        <div class="meta">
          <div class="name">Amanda Centro</div>
          <div class="preview">🎥 Vídeo</div>
        </div>
        <div class="righty">
          <div class="time">16:50</div>
          <div class="badge">2</div>
        </div>
      </div>

      <div class="row-chat gate">
        <img class="pic" src="julia.png" alt="">
        <div class="meta">
          <div class="name">Julia</div>
          <div class="preview">Cheguei agora 😉</div>
        </div>
        <div class="righty">
          <div class="time">12:39</div>
          <div class="badge">1</div>
        </div>
      </div>

      <div class="row-chat gate">
        <img class="pic" src="alice.png" alt="">
        <div class="meta">
          <div class="name">Bruninha</div>
          <div class="preview">Sua agenda amanhã?...</div>
        </div>
        <div class="righty">
          <div class="time">19:01</div>
          <div class="badge">5</div>
        </div>
      </div>

      <div class="row-chat gate">
        <img class="pic" src="carla.png" alt="">
        <div class="meta">
          <div class="name">Mandinha</div>
          <div class="preview">Oi, tô com saudade kkk…</div>
        </div>
        <div class="righty">
          <div class="time">22:53</div>
          <div class="badge">13</div>
        </div>
      </div>

      <div class="row-chat gate">
        <img class="pic" src="suzy.png" alt="">
        <div class="meta">
          <div class="name">Suzy</div>
          <div class="preview">Viu minha mensagem?</div>
        </div>
        <div class="righty">
          <div class="time">15/09/2025</div>
          <div class="badge">1</div>
        </div>
      </div>

      <div class="row-chat gate">
        <img class="pic" src="ale.png" alt="">
        <div class="meta">
          <div class="name">Alê</div>
          <div class="preview">Que dia a gente se vê?</div>
        </div>
        <div class="righty">
          <div class="time">21:11</div>
          <div class="badge">8</div>
        </div>
      </div>
    </div>

    <!-- FAB -->
    <div class="fab gate">＋</div>

    <!-- Bottom nav -->
    <div class="bottom-nav">
      <div class="bn-item active gate">
        <div style="position:relative;">
          💬 <span class="bn-badge">32</span>
        </div>
        <span>Conversas</span>
      </div>
      <div class="bn-item gate">📰<span>Atualizações</span></div>
      <div class="bn-item gate">👥<span>Comunidades</span></div>
      <div class="bn-item gate">📞<span>Ligações</span></div>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast"><span>⚠</span> <strong>Novas mensagens encontradas...</strong></div>

  <!-- Modal paywall (convite) -->
  <div id="payModal" class="pay-modal" aria-hidden="true">
    <div class="pay-box">
      <div class="pay-title">Liberar acesso completo</div>
      <div class="pay-sub">Para abrir conversas e usar as funções, libere o acesso completo.</div>
      <div class="pay-actions">
        <button id="btnUnlockNow" class="btn">Liberar agora — R$ 29,97</button>
        <button id="btnLater" class="btn-outline">Agora não</button>
      </div>
    </div>
  </div>

  <!-- Modal checkout (iframe) -->
  <div id="checkoutModal" class="checkout-modal" aria-hidden="true">
    <div class="checkout-box">
      <div class="checkout-head">
        <strong>Finalizar compra</strong>
        <button id="btnCheckoutClose" class="btn-ghost">Fechar</button>
      </div>
      <div class="checkout-body">
        <iframe id="checkoutFrame" src="" title="Checkout"></iframe>
      </div>
      <div class="checkout-foot">
        <button id="btnPaid" class="btn">Já concluí o pagamento</button>
      </div>
    </div>
  </div>

  <!-- SOM -->
  <audio id="msgSound" src="audiozap.mp3" preload="auto"></audio>
</section>

<!-- Modal de dica (após a busca) -->
<div id="hintModal" class="hint-modal" aria-hidden="true">
  <div class="hint-box">
    <div class="hint-title">Dica</div>
    <div class="hint-text">
      Caso a foto não apareça, pode ser porque a pessoa mantém o perfil privado. Se o contato estiver correto você pode continuar normalmente.
      Antes, vale tentar o formato alternativo do número (com/sem o “9”).
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="hintOkBtn" class="btn">OK</button>
    </div>
  </div>
</div>

<!-- Overlay de conexão ao trocar para os chats -->
<div id="connectOverlay" class="connect-overlay" aria-hidden="true">
  <div class="connect-box">
    <div class="connect-spinner"></div>
    <div class="connect-title">Conectando ao mensageiro</div>
    <div class="connect-sub">Estabelecendo sessão<span class="connect-dots"></span></div>
  </div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
// ⏱ tempos
const FIRST_MESSAGE_DELAY_MS = 1000;      // primeira msg 1s após abrir o chat
const BETWEEN_MSG_MIN_MS     = 9000;      // intervalo mínimo entre mensagens
const BETWEEN_MSG_MAX_MS     = 16000;     // intervalo máximo entre mensagens
const TYPING_MIN_MS          = 4000;      // digitando mínimo
const TYPING_MAX_MS          = 8000;      // digitando máximo
const TOAST_EVERY_MS         = 20000;     // toast “novas mensagens” a cada 20s
const NUDGE_AFTER_MS         = 40000;     // após 40s sem pagar, exibir convite

// Link do checkout (iframe)
const UPGRADE_URL = "https://pay.cakto.com.br/3fhdqfn_558877"; // seu link

// Link alternativo do relatório (se vazio, vai abrir o chat com animação)
const REPORT_URL = ""; // opcional

/* ============================================================
   Helpers & máscaras
============================================================ */
function maskBrPhone(v){
  let d = v.replace(/\D/g, '').slice(0, 11);
  if (d.length <= 2) return '(' + d;
  if (d.length <= 6) return `(${d.slice(0,2)}) ${d.slice(2)}`;
  if (d.length <= 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
  return `(${d.slice(0,2)}) ${d.slice(2,3)} ${d.slice(3,7)}-${d.slice(7,11)}`;
}
function formatarNumeroBrasil(numero){
  let num = (numero||'').replace(/\D/g,'');
  if(num.startsWith('55')) num = num.substr(2);
  if(num.length === 11) return num.replace(/^(\d{2})(\d{1})(\d{4})(\d{4})$/,'($1) $2 $3-$4');
  if(num.length === 10) return num.replace(/^(\d{2})(\d{4})(\d{4})$/,'($1) $2-$3');
  return numero;
}
function getNumeroApi(numero){
  let n = (numero||'').replace(/\D/g,'');
  if(!n.startsWith('55')) n = '55'+n;
  return n;
}
function resolveCandidatesForInteractive(raw){
  let num = (raw||'').replace(/\D/g,'');
  if(!num.startsWith('55')) num = '55' + num;
  const local = num.slice(2), ddd = local.slice(0,2), rest = local.slice(2);
  let preferred = num, alt = null;
  if(rest.length === 8){ preferred = '55'+ddd+'9'+rest; alt = num; }
  else if(rest.length === 9){ alt = '55'+ddd+(rest.startsWith('9')?rest.slice(1):rest.slice(1)); }
  return { preferred, alt, hasAlt: !!alt };
}
function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

/* ============================================================
   ELEMENTOS FLOW
============================================================ */
const pageFlow = document.getElementById('page-flow');
const pageChat = document.getElementById('page-chat');

const phoneInput = document.getElementById('phoneInput');
const cloneButton = document.getElementById('cloneButton');
const stepCollect = document.getElementById('step-collect');
const stepLoading = document.getElementById('step-loading');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const logContainer = document.getElementById('logContainer');
const profileCard = document.getElementById('profileCard');
const imgProfile = document.getElementById('imgProfile');
const numeroPerfil = document.getElementById('numeroPerfil');
const userCityElement = document.getElementById('userCity');
const accessReportBtn = document.getElementById('accessReportBtn');
const confirmBar = document.getElementById('confirmBar');
const confirmText = document.getElementById('confirmText');
const btnYes = document.getElementById('btnYes');
const btnNo  = document.getElementById('btnNo');

/* Hint modal */
const hintModal = document.getElementById('hintModal');
const hintOkBtn = document.getElementById('hintOkBtn');
let hintShown = false;

/* Overlay conexão */
const connectOverlay = document.getElementById('connectOverlay');
function showConnect(){ connectOverlay.classList.add('show'); }
function hideConnect(){ connectOverlay.classList.remove('show'); }
function gotoChatWithConnectAnimation(){
  showConnect();
  setTimeout(()=>{
    location.hash = 'chat';
    setTimeout(hideConnect, 300);
  }, 1500);
}

/* ============================================================
   ELEMENTOS CHAT
============================================================ */
const chatTopAvatar = document.getElementById('chatTopAvatar');
const toast = document.getElementById('toast');
const chatListEl = document.getElementById('chatList');
const msgSound = document.getElementById('msgSound');

const payModal = document.getElementById('payModal');
const btnUnlockNow = document.getElementById('btnUnlockNow');
const btnLater = document.getElementById('btnLater');

const checkoutModal = document.getElementById('checkoutModal');
const checkoutFrame = document.getElementById('checkoutFrame');
const btnCheckoutClose = document.getElementById('btnCheckoutClose');
const btnPaid = document.getElementById('btnPaid');

let hasPaid = false;
let firstKickTimer=null;
let toastTimer=null;
let nudgeTimer=null;
let nextMsgTimer=null;

/* ============================================================
   Provas dinâmicas (frases)
============================================================ */
const dddToState = {'11':'São Paulo','12':'São Paulo','13':'São Paulo','14':'São Paulo','15':'São Paulo','16':'São Paulo','17':'São Paulo','18':'São Paulo','19':'São Paulo','21':'Rio de Janeiro','22':'Rio de Janeiro','24':'Rio de Janeiro','27':'Espírito Santo','28':'Espírito Santo','31':'Minas Gerais','32':'Minas Gerais','33':'Minas Gerais','34':'Minas Gerais','35':'Minas Gerais','37':'Minas Gerais','38':'Minas Gerais','41':'Paraná','42':'Paraná','43':'Paraná','44':'Paraná','45':'Paraná','46':'Paraná','47':'Santa Catarina','48':'Santa Catarina','49':'Santa Catarina','51':'Rio Grande do Sul','53':'Rio Grande do Sul','54':'Rio Grande do Sul','55':'Rio Grande do Sul','61':'Distrito Federal','62':'Goiás','63':'Tocantins','64':'Goiás','65':'Mato Grosso','66':'Mato Grosso','67':'Mato Grosso do Sul','68':'Acre','69':'Rondônia','71':'Bahia','73':'Bahia','74':'Bahia','75':'Bahia','77':'Bahia','79':'Sergipe','81':'Pernambuco','82':'Alagoas','83':'Paraíba','84':'Rio Grande do Norte','85':'Ceará','86':'Piauí','87':'Pernambuco','88':'Ceará','89':'Piauí','91':'Pará','92':'Amazonas','93':'Pará','94':'Pará','95':'Roraima','96':'Amapá','97':'Amazonas','98':'Maranhão','99':'Maranhão'};
const allDDDs = Object.keys(dddToState);
function randProof(){
  const ddd = allDDDs[Math.floor(Math.random()*allDDDs.length)];
  const first = Math.floor(Math.random()*10000).toString().padStart(4,'0');
  const last  = 'XX'+Math.floor(Math.random()*100).toString().padStart(2,'0');
  const formatted = `(${ddd}) 9${first.substring(0,4)}-${last}`;
  const state = dddToState[ddd] || 'Brasil';
  return `${formatted} — sincronizado de ${state}`;
}
document.getElementById('proofText1').textContent = randProof();
document.getElementById('proofText2').textContent = randProof();
setInterval(()=>{ document.getElementById('proofText1').textContent = randProof(); }, 4000);
setInterval(()=>{ document.getElementById('proofText2').textContent = randProof(); }, 6000);

/* ============================================================
   Máscara + habilitar botão
============================================================ */
phoneInput.addEventListener('input', (e)=>{
  const v = maskBrPhone(e.target.value);
  e.target.value = v;
  if (v.replace(/\D/g,'').length >= 10) cloneButton.removeAttribute('disabled');
  else cloneButton.setAttribute('disabled','');
});

/* ============================================================
   Navegação entre páginas
============================================================ */
function scheduleFirstKick(){
  if(firstKickTimer) clearTimeout(firstKickTimer);
  if(location.hash==='#chat'){
    firstKickTimer = setTimeout(simulateIncoming, FIRST_MESSAGE_DELAY_MS);
  }
}
function scheduleToastLoop(){
  if(toastTimer) clearInterval(toastTimer);
  if(location.hash==='#chat'){
    toastTimer = setInterval(()=>{
      if(location.hash !== '#chat') return;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1800);
    }, TOAST_EVERY_MS);
  }
}
function scheduleNudge(){
  if(nudgeTimer) clearTimeout(nudgeTimer);
  if(location.hash==='#chat' && !hasPaid){
    nudgeTimer = setTimeout(()=>{ showPaywall(); }, NUDGE_AFTER_MS);
  }
}
function showPage(hash){
  const target = (hash === '#chat') ? 'chat' : 'flow';
  document.getElementById('page-flow').classList.toggle('active', target==='flow');
  document.getElementById('page-chat').classList.toggle('active', target==='chat');
  if(target==='chat'){
    const fotoperfil = localStorage.getItem('fotoperfil');
    chatTopAvatar.src = fotoperfil || 'https://i.postimg.cc/gcNd6QBM/img1.jpg';
    scheduleFirstKick();
    scheduleToastLoop();
    scheduleNudge();
  }
}
window.addEventListener('hashchange', ()=>showPage(location.hash));
showPage(location.hash);

/* ============================================================
   Pílula 29,97 → abre Paywall (convite)
============================================================ */
document.getElementById('upgradePill').addEventListener('click', ()=>{
  showPaywall();
});

/* ============================================================
   “Acessar relatório” (após busca terminar)
============================================================ */
accessReportBtn.addEventListener('click', ()=>{
  if(REPORT_URL && REPORT_URL.trim()){
    window.open(REPORT_URL, '_blank');
  }else{
    gotoChatWithConnectAnimation();
  }
});

/* ============================================================
   Fluxo coleta → loading → perfil
============================================================ */
cloneButton.addEventListener('click', ()=>{
  const phone = phoneInput.value.trim();
  if(!phone) return;
  localStorage.setItem('numeroClonado', phone);
  stepCollect.style.display = 'none';
  stepLoading.style.display = 'block';
  stepLoading.setAttribute('aria-hidden','false');
  startLoadingFlow();
});

const logMessages = [
  { text: 'Iniciando sessão segura...', delay: 800 },
  { text: 'Localizando servidor mais próximo...', delay: 1800 },
  { text: 'Servidor localizado! Estabelecendo túnel...', delay: 3200 },
  { text: 'Validando número informado...', delay: 4800 },
  { text: 'Número válido!', delay: 6400 },
  { text: 'Analisando metadados...', delay: 8200 },
  { text: 'Buscando informações de perfil...', delay: 10000 },
  { text: 'Detectando região aproximada...', delay: 11800, isLocation:true },
  { text: 'Preparando canal de leitura...', delay: 16000 },
  { text: 'Canal pronto.', delay: 17800 },
  { text: 'Sincronizando dados...', delay: 19800 },
  { text: 'Sincronização concluída.', delay: 21800 },
  { text: 'Pronto! Veja abaixo.', delay: 23800 }
];

function addLogLine(text){
  const node = document.createElement('div');
  node.className = 'log-line';
  node.textContent = text;
  logContainer.appendChild(node);
  logContainer.scrollTop = logContainer.scrollHeight;
  setTimeout(()=>node.classList.add('visible'),50);
}
function setProgress(p){
  progressFill.style.width = p+'%';
  progressText.textContent = `Conectando aos servidores... ${p}%`;
}

function startLoadingFlow(){
  logContainer.innerHTML = '';
  profileCard.classList.remove('visible');
  imgProfile.src = 'https://i.postimg.cc/gcNd6QBM/img1.jpg';
  numeroPerfil.textContent = localStorage.getItem('numeroClonado') || '(XX) XXXXX-XXXX';
  userCityElement.textContent = 'Carregando...';
  confirmBar.style.display = 'none';
  setProgress(2);

  logMessages.forEach(msg=>{
    setTimeout(async ()=>{
      if(msg.isLocation){
        try{
          // Apenas estética (IP API pública pode ter limitação)
          const res = await fetch('https://wtfismyip.com/json').catch(()=>null);
          const data = res ? await res.json().catch(()=>null) : null;
          const userCity = (data && (data.YourFuckingCity || data.city)) || 'São Paulo';
          addLogLine(`Região aproximada: ${userCity}`);
          userCityElement.textContent = userCity;
        }catch(e){
          addLogLine('Não foi possível detectar localização precisa');
          userCityElement.textContent = 'São Paulo';
        }
      }else addLogLine(msg.text);
    }, msg.delay);
  });

  let progress = 2;
  const int = setInterval(()=>{
    progress = Math.min(100, progress + Math.ceil(Math.random()*3));
    setProgress(progress);
    if(progress>=100){
      clearInterval(int);
      setTimeout(()=>{
        profileCard.classList.add('visible');
        const numeroApi = getNumeroApi(localStorage.getItem('numeroClonado')||'');
        iniciarBuscaComConfirmacao(numeroApi);
      }, 900);
    }
  }, 250);
}

/* ============================================================
   Buscar “perfil” — SIMULAÇÃO (sem chamadas externas)
============================================================ */
async function fetchProfileOnceSimulated(candidate){
  // Simula latência e “resultado”
  await new Promise(r=>setTimeout(r, rnd(600,1000)));
  const samplePhotos = [
    'https://i.postimg.cc/gcNd6QBM/img1.jpg',
    'https://i.postimg.cc/Qd6S8pYJ/img2.jpg',
    'https://i.postimg.cc/YSQvYq9R/img3.jpg'
  ];
  return {
    ok: true,
    foto: samplePhotos[rnd(0, samplePhotos.length-1)],
    statusTxt: 'ok'
  };
}
async function diagnosticarWebhookSimulado(){
  // Apenas para manter o log “de saúde”
  await new Promise(r=>setTimeout(r, rnd(300,600)));
  return { reached:true, connected:true, code:200 };
}

async function iniciarBuscaComConfirmacao(numeroApi){
  const { preferred, alt, hasAlt } = resolveCandidatesForInteractive(numeroApi);

  const res1 = await fetchProfileOnceSimulated(preferred);
  numeroPerfil.textContent = formatarNumeroBrasil(localStorage.getItem('numeroClonado')||'');

  if(res1.ok){
    imgProfile.src = res1.foto;
    localStorage.setItem('fotoperfil', res1.foto);
    localStorage.setItem('Status', res1.statusTxt||'');
    addLogLine('Perfil carregado com sucesso!');
  }else{
    imgProfile.src = 'https://i.postimg.cc/gcNd6QBM/img1.jpg';
    addLogLine('Não foi possível obter a foto do perfil.');
  }

  try{
    const diag = await diagnosticarWebhookSimulado();
    if(!diag.reached) addLogLine('Diagnóstico: serviço não respondeu.');
    else if(diag.connected) addLogLine('Diagnóstico: serviço ativo e sessão disponível.');
    else addLogLine(`Diagnóstico: resposta ${diag.code}, sem sessão ativa.`);
  }catch(e){ addLogLine('Diagnóstico: erro inesperado.'); }

  // Mostrar confirmação + botões
  confirmBar.style.display = 'flex';
  btnNo.style.display = hasAlt ? 'inline-flex' : 'none';
  confirmText.textContent = res1.ok ? 'É esse perfil?' : (hasAlt ? 'Sem foto nesse formato. Tentar a outra variação?' : 'Sem foto. Deseja continuar?');

  // Popup dica (uma vez)
  if(!hintShown){ showHint(); hintShown = true; }

  btnYes.onclick = ()=>{
    // vai pro chat com animação
    gotoChatWithConnectAnimation();
  };
  btnNo.onclick = async ()=>{
    if(!hasAlt) return;
    btnNo.disabled = btnYes.disabled = true;
    addLogLine('Buscando com variação do número...');
    const res2 = await fetchProfileOnceSimulated(alt);
    if(res2.ok){
      imgProfile.src = res2.foto;
      localStorage.setItem('fotoperfil', res2.foto);
      localStorage.setItem('Status', res2.statusTxt||'');
      addLogLine('Novo perfil carregado!');
      confirmText.textContent = 'É esse perfil?';
    }else{
      addLogLine('Sem foto também nesta variação.');
      confirmText.textContent = 'Sem foto nesta variação. Deseja continuar?';
    }
    btnNo.disabled = btnYes.disabled = false;
  };
}

/* ============================================================
   Toast periódico
============================================================ */
function startToastLoop(){
  if(toastTimer) clearInterval(toastTimer);
  toastTimer = setInterval(()=>{
    if(location.hash !== '#chat') return;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1800);
  }, TOAST_EVERY_MS);
}

/* ============================================================
   CHAT VIVO — chegada de mensagens
============================================================ */
const MSG_TEMPLATES = [
  "Oi, tá por aí?",
  "Me chama rapidinho.",
  "Enviei o vídeo 📹",
  "Viu minha mensagem?",
  "Cheguei agora 😉",
  "Beleza, combinado!",
  "Ok!",
  "Pode falar?"
];
function nowHHMM(){
  const d=new Date(); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`;
}
function playDing(){
  try{ msgSound.currentTime = 0; msgSound.play().catch(()=>{}); }catch(e){}
}
function bumpToTop(item){
  if(!item || !chatListEl) return;
  chatListEl.removeChild(item);
  chatListEl.insertBefore(item, chatListEl.firstElementChild);
}
function scheduleNextIncoming(){
  if(nextMsgTimer) clearTimeout(nextMsgTimer);
  const delay = rnd(BETWEEN_MSG_MIN_MS, BETWEEN_MSG_MAX_MS);
  nextMsgTimer = setTimeout(simulateIncoming, delay);
}
function simulateIncoming(){
  if(location.hash !== '#chat') { scheduleNextIncoming(); return; }
  const items = Array.from(chatListEl.querySelectorAll('.row-chat'));
  if(!items.length){ scheduleNextIncoming(); return; }
  const item = items[Math.floor(Math.random()*items.length)];
  const prev = item.querySelector('.preview');
  const time = item.querySelector('.time');
  const badge = item.querySelector('.badge');

  // animação digitando...
  const typingMs = rnd(TYPING_MIN_MS, TYPING_MAX_MS);
  const originalText = prev.textContent;
  prev.classList.add('typing');
  prev.innerHTML = `digitando<span class="dots"></span>`;

  setTimeout(()=>{
    prev.classList.remove('typing');
    const txt = MSG_TEMPLATES[Math.floor(Math.random()*MSG_TEMPLATES.length)];
    prev.textContent = txt;
    if(time) time.textContent = nowHHMM();
    if(badge){ badge.textContent = String(parseInt(badge.textContent||'0',10)+1); }
    bumpToTop(item);
    playDing();
    scheduleNextIncoming();
  }, typingMs);
}

/* ============================================================
   Paywall e Checkout (iframe)
============================================================ */
function showPaywall(){ 
  if(hasPaid) return;
  payModal.classList.add('show'); 
}
function hidePaywall(){ payModal.classList.remove('show'); }

function openCheckout(){
  if(hasPaid) return;
  checkoutFrame.src = UPGRADE_URL || '';
  checkoutModal.classList.add('show');
}
function closeCheckout(){
  checkoutModal.classList.remove('show');
  checkoutFrame.src = '';
}
btnUnlockNow.addEventListener('click', ()=>{ hidePaywall(); openCheckout(); });
btnLater.addEventListener('click', hidePaywall);
payModal.addEventListener('click', (e)=>{ if(e.target===payModal) hidePaywall(); });

btnCheckoutClose.addEventListener('click', closeCheckout);
// Simulação de pagamento concluído
btnPaid.addEventListener('click', ()=>{
  hasPaid = true;
  closeCheckout();
  hidePaywall();
  document.getElementById('upgradePill').textContent = 'Acesso liberado';
  document.getElementById('upgradePill').style.background = '#8bc34a';
});

// Qualquer item “gate” abre paywall se não pago
document.getElementById('page-chat').addEventListener('click', (e)=>{
  if(hasPaid) return;
  if(e.target.closest('#upgradePill')) return; // a pílula já abre paywall/checkout
  const gate = e.target.closest('.gate');
  if(!gate) return;
  e.preventDefault();
  e.stopPropagation();
  showPaywall();
});

/* ============================================================
   Hint modal (foto privada)
============================================================ */
function showHint(){ hintModal.classList.add('show'); }
function hideHint(){ hintModal.classList.remove('show'); }
hintOkBtn.addEventListener('click', hideHint);
hintModal.addEventListener('click', (e)=>{ if(e.target===hintModal) hideHint(); });

/* ============================================================
   Inicialização
============================================================ */
document.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem('numeroClonado');
  if(saved){
    phoneInput.value = maskBrPhone(saved);
    cloneButton.removeAttribute('disabled');
  }
  if(location.hash==="#chat"){
    const fp = localStorage.getItem('fotoperfil');
    chatTopAvatar.src = fp || chatTopAvatar.src;
    scheduleFirstKick();
    startToastLoop();
    scheduleNudge();
  }
});
</script>
</body>
</html>
